## 目录结构

```
+---Common
|   +---DataProc
|   |       DataProc.cpp
|   |       DataProc.h
|   |       DataProc_Def.h
|   |       DP_Clock.cpp
|   |       DP_GPS.cpp
|   |       DP_IMU.cpp
|   |       DP_LIST.inc
|   |       DP_MAG.cpp
|   |       DP_MusicPlayer.cpp
|   |       DP_Power.cpp
|   |       DP_Recorder.cpp
|   |       DP_SportStatus.cpp
|   |       DP_Storage.cpp
|   |       DP_SysConfig.cpp
|   |       DP_TrackFilter.cpp
|   |       DP_TzConv.cpp  
|   |  
+---Utils       
    +---DataCenter
    |   |   Account.cpp
    |   |   Account.h
    |   |   DataCenter.cpp
    |   |   DataCenter.h
    |   |   DataCenterLog.h
    |   |   
    |   +---PingPongBuffer
    |           PingPongBuffer.c
    |           PingPongBuffer.h
+---APP.cpp
+---APP.h
```



## 消息框架的作用





## 消息框架的使用



### Account

一个Account可以理解为一个功能模块，比如GPS、IMU、播放器等。Account具备以下特点：

+ 一个Account有且仅有一个标识名，例如GPS的Account标识为"GPS"，播放器的Account标识为“MusicPlayer”；
+ 一个Account仅维护一种信息，例如GPS信息，其他Account可以通过订阅获悉该信息；
+ Account A可以主动订阅Account B的信息，一个Account清楚自己向哪些Account进行了订阅，也清楚有哪些Account向自己进行了订阅；
+ Account订阅本质是一种建立双向交流的契约。A向B订阅后，B的信息变化有义务通知到A，A也可以主动向B进行信息查询，此外，A如果愿意也可以主动向B告知自己的信息。
+ 未经过订阅来建立交流契约的两个Account之间是无法交流各自维护的信息的。



### 消息类型

| 类型              | 含义                                                         | 实例                                                         |
| ----------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| EVENT_PUB_PUBLISH | Account将自己最新缓存的信息通知给所有订阅了自己信息的Account | GPS Account 将最新的GPS同步给LiveMapModel、TrackFilter等Account |
| EVENT_SUB_PULL    | Account向某个已订阅的Account主动查询最新缓存的信息           | StatusBar Account 向Storage Account主动查询最新的存储空间余量 |
| EVENT_NOTIFY      | Account将自己的最新缓存的信息通知给某个已订阅的Account       | GPS Account 将自己的信号连接情况主动通知给MusicPlayer Account以进行对应语音提示 |
| EVENT_TIMER       | 周期定时事件                                                 | 每10ms检查GPS信号连接情况                                    |



## 消息框架的原理

```cpp
// DataProc.cpp DataProc.h
void DataProc_Init()
{
 	Account* actStorage = new Account("Storage", &center, 0);   
    do{ 
        void _DP_Storage_Init(Account* account); 
        _DP_Storage_Init(actStorage);
    }while(0);
    
    Account* actGPS = new Account("GPS", &center, sizeof(HAL::GPS_Info_t));
	do{ 
        void _DP_GPS_Init(Account* account); 
        _DP_GPS_Init(actGPS);
    }while(0);    
    
    /* 
    ... 
    */
}
```

```cpp
// DP_GPS.cpp
void _DP_GPS_Init(Account* account)
{
    account->Subscribe("MusicPlayer");
    account->SetEventCallback(onEvent);
    account->SetTimerPeriod(CONFIG_GPS_REFR_PERIOD);
}

static int onEvent(Account* account, Account::EventParam_t* param)
{
    if (param->event == Account::EVENT_TIMER)
    {
        onTimer(account);
        return Account::RES_OK;
    }

    if (param->event != Account::EVENT_SUB_PULL)
    {
        return Account::RES_UNSUPPORTED_REQUEST;
    }

    if (param->size != sizeof(HAL::GPS_Info_t))
    {
        return Account::RES_SIZE_MISMATCH;
    }

    HAL::GPS_GetInfo((HAL::GPS_Info_t*)param->data_p);

    return Account::RES_OK;
}
```



## 优缺点分析

### 优点



### 缺陷

+ Account 作为一个功能模块，却只有一个话题标识名，不能有多个话题接口以提供不同的信息。
+ 缺少Account A向另一个Account B进行主动配置的明确功能，要做到A设置B，就只能让B监听A的信息变化然后作出相应配置改变（或者通过NOTIFY接口让B作相应动作，但是这个方式不容易让人理解）。
+ Account A想主动通知Account B，却要A去订阅B，但B又不会将自己的信息publish到A，整个操作就显得很奇怪。
+ Account 目前的订阅操作更像是建立节点间路由关系，而没有达到话题订阅-发布这样的机制。